<!DOCTYPE html>
<html lang="en">
<head>
    <!--
        AUTHOR NAME: Anders Tornblad
        GITHUB USER: atornblad
        GITHUB REPO: https://github.com/atornblad/js-mod-player
        LICENSE:     Creative Commons Attribution-NonCommercial 4.0 International License
                     https://creativecommons.org/licenses/by-nc/4.0/
    -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS-MOD-player by Anders Tornblad</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="style.css">
    <link rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
    <link rel="repository" href="https://github.com/atornblad/js-mod-player">
</head>

<body>
    <header>
        <h1>JS-MOD-player</h1>
        <p>Vanilla JavaScript MOD player, made by <a href="https://atornblad.se/">Anders Tornblad</a></p>
        <p>GitHub repository: <a href="https://github.com/atornblad/js-mod-player">atornblad/js-mod-player</a></p>
        <p>License: <a href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></p>
    </header>
    <main>
        <h2>Modules</h2>
        <p>These modules are loaded from <a href="https://modarchive.org/">The Mod Archive</a>.</p>
        <p>
            <button class="mod-player" data-modinfo="https://modarchive.org/module.php?48324" data-modfile="https://api.modarchive.org/downloads.php?moduleid=48324">Sanity Arte part 1</button>
            <button class="mod-player" data-modinfo="https://modarchive.org/module.php?41529" data-modfile="https://api.modarchive.org/downloads.php?moduleid=41529">Sanity Arte part 2</button>
            <button class="mod-player" data-modinfo="https://modarchive.org/module.php?101789" data-modfile="https://api.modarchive.org/downloads.php?moduleid=101789">Phenomena Enigma</button>
            <button class="mod-player" data-modinfo="https://modarchive.org/module.php?122692" data-modfile="https://api.modarchive.org/downloads.php?moduleid=122692">Brainblast</button>
        </p>
        <p>You can also paste a Mod Archive URL, but keep in mind that only ProTracker MOD files work correctly:</p>
        <p>
            <input type="url" id="mod-archive-url" placeholder="https://modarchive.org/....." />
            <button class="mod-player" id="url-load" disabled>Load and play</button>
        </p>
        <p><strong>DANGER:</strong> You can also type any URL of a Protracker MOD file:</p>
        <p>
            <input type="url" id="any-url" placeholder="https://ftp.modland.com/....." />
            <button class="mod-player" id="any-url-load" disabled>Load and play</button>
        </p>
        <h2>Playback</h2>
        <p>
            <label for="songposrange">Position: </label>
            <input type="range" min="0" max="127" value="0" id="songposrange" />
            <input type="number" min="0" max="127" value="0" id="songposinput" />
        </p>
        <table>
            <tr>
                <th>Channel 1</th>
                <th>Channel 2</th>
                <th>Channel 3</th>
                <th>Channel 4</th>
            </tr>
            <tr>
                <td><div class="note_display" id="note-disp-1"></div></td>
                <td><div class="note_display" id="note-disp-2"></div></td>
                <td><div class="note_display" id="note-disp-3"></div></td>
                <td><div class="note_display" id="note-disp-4"></div></td>
            </tr>
        </table>
        <p>
            <button id="stop">Stop</button>
            <button id="resume">Resume</button>
        </p>
        <p>
            <label for="volume">Volume: </label>
            <input type="range" min="0" max="100" value="30" id="volume" />
        </p>
        <p id="song"></p>
        <p id="output">Playing song <a id="songinfo" href="" target="_blank"><span id="songname">---</span><br>
            Mod file source: <a id="modfile" href="" download>----</a></p>
        <p id="instruments"><strong>Instruments:</strong></p>
    </main>
    <footer>
        <h2>Blog posts:</h2>
        <ul>
            <li>Part 1: <a href="https://atornblad.se/generating-sound-in-modern-web-audio-api">Generating sound in modern Web Audio API</a></li>
            <li>Part 2: <a href="https://atornblad.se/loading-mod-files-in-the-browser">Loading MOD files in the browser</a></li> 
            <li>Part 3: <a href="https://atornblad.se/playing-a-full-song-almost">Playing a full song, almost</a></li>
            <li>Part 4: <a href="https://atornblad.se/implementing-looping-and-the-first-effects">Implementing looping and the first effects</a></li>
            <li>Part 5: <a href="https://atornblad.se/adding-pitch-related-effects">Adding pitch-related effects</a></li>
            <li>Part 6: <a href="https://atornblad.se/syncopation-and-a-human-touch">Syncopation and a human touch</a></li>
            <li>Part 7: <a href="https://atornblad.se/using-music-as-a-timing-source-for-demos">Using music as a timing source for demos</a></li>
            <li>Part 8: <a href="https://atornblad.se/making-the-mod-player-available">Making the MOD player available</a></li>
        </ul>
    </footer>

    <script type="module">
        import { ModPlayer } from 'https://atornblad.se/files/js-mod-player/player.js?v=20260130';

        const
            spr = document.getElementById('songposrange'),
            spi = document.getElementById('songposinput'),
            stop = document.getElementById('stop'),
            resume = document.getElementById('resume'),
            song = document.getElementById('song'),
            output = document.getElementById('output'),
            songinfo = document.getElementById('songinfo'),
            songname = document.getElementById('songname'),
            modfile = document.getElementById('modfile'),
            volume = document.getElementById('volume'),
            urlInput = document.getElementById('mod-archive-url'),
            urlButton = document.getElementById('url-load'),
            urlInput2 = document.getElementById('any-url'),
            urlButton2 = document.getElementById('any-url-load'),
            instruments = document.getElementById('instruments'),
            noteDisplays = [...document.querySelectorAll('div.note_display')];

        for (let noteDisp of noteDisplays) {
            noteDisp.style.display = 'inline-block';
            noteDisp.style.width = '20px';
            noteDisp.style.height = '64px';
            noteDisp.parentElement.style.textAlign = 'center';
            noteDisp.style.backgroundColor = '#ddd';
            noteDisp._vol = 0;
        }

        window.setInterval(() => {
            for (let noteDisp of noteDisplays) {
                if (noteDisp._vol) {
                    const percent = (64 - noteDisp._vol) * 100 / 64;
                    const perc = percent.toFixed(0);
                    noteDisp.style.background = `linear-gradient(#eee, #eee ${perc}%, #f55 ${perc}%, #dd5, #5b5)`;
                    noteDisp._vol = Math.max(0, noteDisp._vol - 3);
                }
                else {
                    noteDisp.style.background = '#eee';
                }
            }
        }, 20);

        const audio = new AudioContext();
        const modPlayer = new ModPlayer(audio);

        spr.addEventListener('input', e => {
            spi.value = spr.value;
            modPlayer.setRow(parseInt(spr.value, 10), 0);
        });
        spi.addEventListener('input', e => {
            spr.value = spi.value;
            modPlayer.setRow(parseInt(spr.value, 10), 0);
        });
        stop.addEventListener('click', e => {
            modPlayer.stop();
        });
        resume.addEventListener('click', e => {
            modPlayer.resume();
        });
        volume.addEventListener('input', e => {
            modPlayer.setVolume(0.01 * volume.value);
        });

        urlInput.addEventListener('input', e => {
            const url = urlInput.value;
            const permaMatch = url.match(/modarchive\.org\/module\.php\?(\d+)/);
            const queryMatch = url.match(/modarchive\.org\/index\.php\?.*query=(\d+)/);
            const downloadMatch = url.match(/api\.modarchive\.org\/downloads\.php\?.*moduleid=(\d+)/);
            const theMatch = permaMatch ?? queryMatch ?? downloadMatch;
            const modId = theMatch[1];
            if (theMatch) {
                urlButton.dataset.modinfo = `https://modarchive.org/module.php?${modId}`;
                urlButton.dataset.modfile = `https://api.modarchive.org/downloads.php?moduleid=${modId}`;
                urlButton.disabled = false;
            }
            else {
                urlButton.dataset.modinfo = '';
                urlButton.dataset.modfile = '';
                urlButton.disabled = true;
            }
        });

        urlInput.addEventListener('keydown', e => {
            if (e.code === 'Enter') {
                urlButton.click();
            }
        });

        urlInput2.addEventListener('input', e => {
            const url = urlInput2.value;
            urlButton2.dataset.modinfo = '';
            urlButton2.dataset.modfile = url;
            urlButton2.disabled = url.trim().length < 15;
        });

        urlInput2.addEventListener('keydown', e => {
            if (e.code === 'Enter') {
                urlButton2.click();
            }
        });

        const modPlayerButtons = Array.from(document.querySelectorAll('button.mod-player'));
        for (let button of modPlayerButtons) {
            let stopped = false;

            button.addEventListener('click', async (e) => {
                const modFile = button.dataset.modfile;
                const infoUrl = button.dataset.modinfo;
                urlInput.value = infoUrl;
                urlInput2.value = modFile;
                urlButton.disabled = false;
                modPlayer.unload();
                await modPlayer.load(modFile);
                const instrumentNames = modPlayer.mod.instruments.filter(i => !!i && !!i.name).map((i, idx) => `<span class="instrument-name" title="Instrument ${idx}">${i.name}</span>`);
                instruments.innerHTML = '<strong>Instruments:</strong><br>' + instrumentNames.join('<br>');
                console.log(instrumentNames);
                modPlayer.setVolume(0.01 * volume.value);
                modPlayer.watchRows((songPos, row) => {
                    spr.value = songPos;
                    spi.value = songPos;
                    if (!stopped) {
                        output.textContent = `Song position: ${songPos}, bar: ${row >> 2} (row ${row})`;
                    }
                });
                modPlayer.watchStop(() => {
                    stopped = true;
                    output.textContent = 'Song stopped';
                });
                modPlayer.watchNotes(({channel, sample, volume, note}) => {
                    noteDisplays[channel - 1]._vol = volume;
                });

                spr.max = modPlayer.mod.length - 1;
                spi.max = modPlayer.mod.length - 1;

                if (infoUrl) {
                    song.innerHTML = `Playing song <a target="_blank" href="${infoUrl}">${modPlayer.mod.name} <em>(From The Mod Archive)</em></a><br/>Mod file source: <a href="${modFile}" download>${modFile}</a><br/>`;
                } else {
                    song.innerHTML = `Playing song <strong>${modPlayer.mod.name}</strong><br/>Mod file source: <a href="${modFile}" download>${modFile}</a><br/>`;
                }

                modPlayer.play();
            });
        }
    </script>
</body>
</html>